{{ define "main" }}
  {{ .Scratch.Set "scope" "list" }}

  {{/* Header */}}
  <header>
    {{ if .Params.showBreadcrumbs | default (site.Params.list.showBreadcrumbs | default false) }}
      {{ partial "breadcrumbs.html" . }}
    {{ end }}
    <h1 class="mt-5 text-4xl font-extrabold text-neutral-900 dark:text-neutral">{{ .Title }}</h1>
    <div class="mt-1 mb-2 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      {{ partial "article-meta/list.html" (dict "context" . "scope" "single") }}
    </div>
  </header>

  {{/* Description (markdown content) */}}
  <section class="mt-0 prose flex max-w-full flex-col dark:prose-invert lg:flex-row">
    <div class="min-w-0 min-h-0 max-w-prose">
      {{ .Content }}
    </div>
  </section>

  {{/* Get all posts from zh-tw site specifically */}}
  {{ $zhtwSites := where site.Sites ".Language.Lang" "zh-tw" }}
  {{ $allPages := slice }}
  {{ if $zhtwSites }}
    {{ $zhtwSite := index $zhtwSites 0 }}
    {{ $allPages = where $zhtwSite.RegularPages "Type" "in" site.Params.mainSections }}
  {{ else }}
    {{ $allPages = where .Site.RegularPages "Type" "in" site.Params.mainSections }}
  {{ end }}

  {{/* 年度篩選導航 */}}
  {{ if gt (len $allPages) 0 }}
    <nav class="year-filter mb-8 p-4 bg-neutral-100 dark:bg-neutral-800 rounded-lg">
      <h2 class="text-lg font-bold mb-3">按年份篩選</h2>
      <div class="flex flex-wrap gap-2">
        <button data-year="all" class="year-filter-btn active m-1 px-3 py-1 bg-primary-500 text-white dark:bg-primary-600 rounded hover:bg-primary-600 dark:hover:bg-primary-700 transition-colors">
          全部 ({{ len $allPages }})
        </button>
        {{ $years := slice }}
        {{ range $allPages.GroupByDate "2006" }}
          {{ $years = $years | append (dict "year" .Key "count" (len .Pages)) }}
        {{ end }}
        {{ range $years }}
          <button data-year="{{ .year }}" class="year-filter-btn m-1 px-3 py-1 bg-neutral-200 dark:bg-neutral-700 text-neutral-700 dark:text-neutral-300 rounded hover:bg-primary-200 dark:hover:bg-primary-800 transition-colors">
            {{ .year }} ({{ .count }})
          </button>
        {{ end }}
      </div>
    </nav>

    {{/* 系列文章導航 */}}
    {{ $series := .Site.Taxonomies.series }}
    {{ if $series }}
    <nav class="series-navigation mb-8 p-4 bg-neutral-100 dark:bg-neutral-800 rounded-lg">
      <h2 class="text-lg font-bold mb-3">系列文章</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {{ range $name, $items := $series }}
          {{ $count := len $items }}
          {{ if gt $count 2 }}
          <div class="series-item">
            <a href="/series/{{ $name | urlize }}/" class="flex items-center justify-between p-2 hover:bg-neutral-200 dark:hover:bg-neutral-700 rounded transition-colors">
              <span class="font-medium">{{ $name }}</span>
              <span class="text-sm text-neutral-500 dark:text-neutral-400">{{ $count }} 篇</span>
            </a>
          </div>
          {{ end }}
        {{ end }}
      </div>
    </nav>
    {{ end }}
  {{ end }}

  {{/* Article List */}}
  {{ if gt (len $allPages) 0 }}
    {{ $groupByYear := .Params.groupByYear | default (site.Params.list.groupByYear | default true) }}
    
    {{/* 預設分頁模式的文章容器 */}}
    <section id="articles-container" class="space-y-10 w-full">
      {{/* 使用 Hugo 的分頁功能 */}}
      {{ range (.Paginate ($allPages.GroupByDate "2006")).PageGroups }}
        {{ if $groupByYear }}
          <h2 id="year-{{ .Key }}" class="year-header mt-12 text-2xl font-bold text-neutral-700 first:mt-8 dark:text-neutral-300" data-year="{{ .Key }}">
            {{ .Key }}
            <span class="text-sm text-neutral-500 dark:text-neutral-400 ml-2">({{ len .Pages }} 篇)</span>
          </h2>
        {{ end }}
        {{ range .Pages }}
          {{ $year := .Date.Format "2006" }}
          <article class="article-item" data-year="{{ $year }}" data-date="{{ .Date.Format "2006-01-02" }}">
            {{ $currentLang := $.Site.Language.Lang }}
            {{ if eq $currentLang "zh-tw" }}
              {{ partial "article-link/simple.html" . }}
            {{ else }}
              {{ partial "article-link/simple.html" . }}
            {{ end }}
          </article>
        {{ end }}
      {{ end }}
    </section>
    
    {{/* 篩選模式的隱藏文章容器（包含所有文章） */}}
    <section id="all-articles-container" class="space-y-10 w-full hidden">
      {{ range ($allPages.GroupByDate "2006") }}
        <h2 class="year-header-all mt-12 text-2xl font-bold text-neutral-700 first:mt-8 dark:text-neutral-300" data-year="{{ .Key }}">
          {{ .Key }}
          <span class="text-sm text-neutral-500 dark:text-neutral-400 ml-2">({{ len .Pages }} 篇)</span>
        </h2>
        {{ range .Pages }}
          {{ $year := .Date.Format "2006" }}
          <article class="article-item-all" data-year="{{ $year }}" data-date="{{ .Date.Format "2006-01-02" }}">
            {{ $currentLang := $.Site.Language.Lang }}
            {{ if eq $currentLang "zh-tw" }}
              {{ partial "article-link/simple.html" . }}
            {{ else }}
              {{ partial "article-link/simple.html" . }}
            {{ end }}
          </article>
        {{ end }}
      {{ end }}
    </section>
    
    {{/* 分頁器 */}}
    <div id="pagination-container" class="mt-8">
      {{ partial "pagination.html" . }}
    </div>
    
    {{/* 年份篩選訊息 */}}
    <div id="filter-message" class="mt-8 text-center text-neutral-500 dark:text-neutral-400 hidden">
      <p id="filter-text"></p>
      <p class="text-sm mt-2">
        <button id="clear-filter" class="text-primary-500 hover:text-primary-600 underline">清除篩選，回到分頁模式</button>
      </p>
    </div>
  {{ else }}
    <section class="mt-10 prose dark:prose-invert">
      <p class="py-8 border-t">
        <em>{{ i18n "list.no_articles" | emojify }}</em>
      </p>
    </section>
  {{ end }}

{{ end }}