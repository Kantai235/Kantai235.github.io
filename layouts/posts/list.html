{{ define "main" }}
  {{ .Scratch.Set "scope" "list" }}

  {{/* Header */}}
  <header>
    {{ if .Params.showBreadcrumbs | default (site.Params.list.showBreadcrumbs | default false) }}
      {{ partial "breadcrumbs.html" . }}
    {{ end }}
    <h1 class="mt-5 text-4xl font-extrabold text-neutral-900 dark:text-neutral">{{ .Title }}</h1>
    <div class="mt-1 mb-2 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      {{ partial "article-meta/list.html" (dict "context" . "scope" "single") }}
    </div>
  </header>

  {{/* Description (markdown content) */}}
  <section class="mt-0 prose flex max-w-full flex-col dark:prose-invert lg:flex-row">
    <div class="min-w-0 min-h-0 max-w-prose">
      {{ .Content }}
    </div>
  </section>

  {{/* Get all posts from zh-tw site specifically */}}
  {{ $zhtwSites := where site.Sites ".Language.Lang" "zh-tw" }}
  {{ $allPages := slice }}
  {{ if $zhtwSites }}
    {{ $zhtwSite := index $zhtwSites 0 }}
    {{ $allPages = where $zhtwSite.RegularPages "Type" "in" site.Params.mainSections }}
  {{ else }}
    {{ $allPages = where .Site.RegularPages "Type" "in" site.Params.mainSections }}
  {{ end }}

  {{/* Article List */}}
  {{ if gt (len $allPages) 0 }}
    {{ $groupByYear := .Params.groupByYear | default (site.Params.list.groupByYear | default false) }}
    
    <section class="space-y-10 w-full">
      {{ range ($allPages.GroupByDate "2006") }}
        {{ if $groupByYear }}
          <h2 class="mt-12 text-2xl font-bold text-neutral-700 first:mt-8 dark:text-neutral-300">
            {{ .Key }}
          </h2>
        {{ end }}
        {{ range .Pages }}
          {{/* Create a modified page context with language-appropriate URL */}}
          {{ $currentLang := $.Site.Language.Lang }}
          {{ $currentPage := . }}
          {{ if eq $currentLang "zh-tw" }}
            {{ partial "article-link/simple.html" . }}
          {{ else }}
            {{/* Generate URL for current language */}}
            {{ $langPrefix := "" }}
            {{ if ne $currentLang "zh-tw" }}
              {{ $langPrefix = printf "/%s" $currentLang }}
            {{ end }}
            {{ $newURL := printf "%s%s" $langPrefix .RelPermalink }}
            {{/* Override the RelPermalink temporarily */}}
            {{ .Scratch.Set "originalRelPermalink" .RelPermalink }}
            {{ .Scratch.Set "modifiedRelPermalink" $newURL }}
            <div class="group-hover-card group flex flex-wrap md:flex-nowrap article relative">
              <a href="{{ $newURL }}" class="absolute inset-0" aria-label="{{ .Title }}"></a>
              {{/* Feature image handling */}}
              {{- $images := .Resources.ByType "image" -}}
              {{- $featured := $images.GetMatch "*feature*" -}}
              {{- if not $featured }}{{ $featured = $images.GetMatch "{*cover*,*thumbnail*}" }}{{ end -}}
              {{ if and .Params.featureimage (not $featured) }}
                {{- $url:= .Params.featureimage -}}
                {{ $featured = resources.GetRemote $url }}
              {{ end }}
              {{- if not $featured }}
                {{ with .Site.Params.defaultFeaturedImage }}{{ $featured = resources.Get . }}{{ end }}
              {{ end -}}
              {{ if .Params.hideFeatureImage }}{{ $featured = false }}{{ end }}
              {{- with $featured -}}
                {{ $disableImageOptimization := $.Site.Params.disableImageOptimization | default false }}
                {{ if or $disableImageOptimization (strings.HasSuffix $featured ".svg") }}
                  <div class="w-full md:w-auto h-full thumbnail nozoom thumbnailshadow md:mr-7" style="background-image:url({{ .RelPermalink }});"></div>
                {{ else }}
                  {{ with .Resize "600x" }}
                    <div class="w-full md:w-auto h-full thumbnail nozoom thumbnailshadow md:mr-7" style="background-image:url({{ .RelPermalink }});"></div>
                  {{ end }}
                {{ end }}
              {{- end -}}
              
              <div class="mt-3 md:mt-0">
                <div class="items-center text-left text-xl font-semibold">
                  <div class="group-hover-card-title decoration-primary-500 dark:text-neutral text-xl font-bold text-neutral-800 group-hover:underline group-hover:underline-offset-2">
                    {{ .Title | emojify }}
                  </div>
                  {{ if and .Draft .Site.Params.article.showDraftLabel }}
                    <div class="ltr:ml-2 rtl:mr-2">{{ partial "badge.html" (i18n "article.draft" | emojify) }}</div>
                  {{ end }}
                </div>
                <div class="group-hover-cancel text-sm text-neutral-500 dark:text-neutral-400">
                  {{ partial "article-meta/basic.html" . }}
                </div>
                {{ if .Params.showSummary | default (.Site.Params.list.showSummary | default false) }}
                  <div class="prose dark:prose-invert max-w-fit py-1">{{ .Summary | plainify }}</div>
                {{ end }}
              </div>
            </div>
          {{ end }}
        {{ end }}
      {{ end }}
    </section>
  {{/* else: no articles */}}
  {{ else }}
    <section class="mt-10 prose dark:prose-invert">
      <p class="py-8 border-t">
        <em>{{ i18n "list.no_articles" | emojify }}</em>
      </p>
    </section>
  {{ end }}

{{ end }}