{{/* Custom multilingual switcher that works for all pages */}}
{{ if gt (len site.Sites) 1 }}
  <div>
    <div class="cursor-pointer flex items-center nested-menu">
      <span class="ltr:mr-1 rtl:ml-1">
        {{ partial "icon.html" "language" }}
      </span>
      <div
        class="text-sm font-medium text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"
        title="{{ .Title }}">
        {{- i18n "global.language" | markdownify -}}
      </div>
    </div>
    <div class="absolute menuhide">
      <div class="pt-2 p-5 mt-2 rounded-xl backdrop-blur shadow-2xl">
        <div class="flex flex-col space-y-3">
          {{ range site.Sites }}
            {{ $targetLang := .Language.Lang }}
            {{ $currentPageLang := $.Site.Language.Lang }}
            {{ $isActive := eq $targetLang $currentPageLang }}
            {{ $targetURL := "" }}
            
            {{/* URL construction using regex replacement */}}
            {{ $currentURL := $.RelPermalink }}
            
            {{ if eq $.Kind "home" }}
              {{/* Home page */}}
              {{ if eq $targetLang "zh-tw" }}
                {{ $targetURL = "/" }}
              {{ else }}
                {{ $targetURL = printf "/%s/" $targetLang }}
              {{ end }}
            {{ else }}
              {{/* For other pages, use pattern replacement */}}
              {{ if eq $targetLang "zh-tw" }}
                {{/* Remove language prefix for zh-tw */}}
                {{ $targetURL = replaceRE "^/(en|ja)/" "/" $currentURL }}
              {{ else }}
                {{/* Replace or add language prefix */}}
                {{ if or (hasPrefix $currentURL "/en/") (hasPrefix $currentURL "/ja/") }}
                  {{/* Replace existing language prefix */}}
                  {{ $targetURL = replaceRE "^/(en|ja)/" (printf "/%s/" $targetLang) $currentURL }}
                {{ else }}
                  {{/* Add language prefix to zh-tw URL */}}
                  {{ $targetURL = printf "/%s%s" $targetLang $currentURL }}
                {{ end }}
              {{ end }}
            {{ end }}
            
            <a href="{{ $targetURL }}" class="flex items-center">
              <p
                class="text-sm font-sm {{ if $isActive }}text-primary-600 dark:text-primary-400 font-medium{{ else }}text-gray-500 hover:text-primary-600 dark:hover:text-primary-400{{ end }}"
                title="{{ .Title }}">
                {{ .Language.Params.displayName | emojify }}
              </p>
            </a>
          {{ end }}
        </div>
      </div>
    </div>
  </div>
{{ end }}